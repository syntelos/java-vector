<project name="build-version">

  <macrodef name="version-tag">
    <attribute name="prefix"/>
    <sequential>
      <java classname="VersionTag" classpath="ant" fork="true" failonerror="true">
        <arg value="@{prefix}"/>
      </java>
    </sequential>
  </macrodef>

  <macrodef name="version">
    <sequential>
      <property file="build.version" />
      <fail unless="version.major" message="Invalid contents for file 'build.version', missing 'version.major'."/>
      <fail unless="version.minor" message="Invalid contents for file 'build.version', missing 'version.minor'."/>
      <fail unless="version.build" message="Invalid contents for file 'build.version', missing 'version.build'."/>

      <property name="base.version" value="${version.major}.${version.minor}"/>

      <condition property="this.version" value="${base.version}" else="${base.version}.${version.build}">
        <equals arg1="0" arg2="${version.build}"/>
      </condition>

      <echo>         ${ant.project.name} ${this.version}
      </echo>

    </sequential>
  </macrodef>

  <macrodef name="version-minor">
    <sequential>
      <version-tag prefix="close"/>
      <propertyfile file="build.version">
        <entry key="version.minor" type="int" operation="+" value="1"/>
        <entry key="version.build" type="int" value="0"/>
      </propertyfile>
      <version-tag prefix="open"/>
    </sequential>
  </macrodef>

  <macrodef name="version-major">
    <sequential>
      <version-tag prefix="close"/>
      <propertyfile file="build.version">
        <entry key="version.major" type="int" operation="+" value="1"/>
        <entry key="version.minor" type="int" value="0"/>
        <entry key="version.build" type="int" value="0"/>
      </propertyfile>
      <version-tag prefix="open"/>
    </sequential>
  </macrodef>

  <macrodef name="version-build">
    <sequential>
      <version-tag prefix="close"/>
      <propertyfile file="build.version">
        <entry key="version.build" type="int" operation="+" value="1"/>
      </propertyfile>
      <version-tag prefix="open"/>
    </sequential>
  </macrodef>

</project>
